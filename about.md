# ClusterManager #

## Испрользуемые обозначения ##
Нода - программа получающая задания и выполняющая их на своем компьютере. Отчитывается о состоянии выполнения заданий перед мастером. В кластере их может быть много.

Мастер - программа, которая контролирует выполнение заданий на нодах. Он сообщает нодам, что им нужно выполнить. Полностью контролирует процессы, работающие на нодах (может останавливать и добавлять новые). Ровно один на кластер.

Кластер - совокупность мастера и нод.

## Работа системы ##

### Цель ###
---
Основной задачей проекта было написать кластер. 
От него хотелось, чтобы он умел запускать на нодах, 
которые к нему подключаются, различные, заранее заданные программы. У него должна была быть конфигурация, то есть файл, в котором описано какие программы на каких нодах следует запускать. Так же он должен был уметь отслеживать текущее состояние работующих программ. В случае ошибки ноды должны были пытаться перезапустить упавшие процессы, однако если нодам это не удавалось мастер должен был уметь передавать этот процесс другим нодам. Так же он должен был уметь отслеживать отключения тех или иных нод и правильно их обрабатывать.

### Передача информации между мастером и нодами ###
---
Вся передача ведется в формате http запросов от нод к мастеру.

Формат всех запросов json.
Каждый запрос от ноды содержит 2 обязательных поля:
1) name (Имя самой ноды) 
2) status (Некоторый формат запроса)

Есть 4 возможных варианта status: 
1) READY 
2) OK 
3) FAIL 
4) UNABLE_TO_LAUNCH
5) SUCCSESS

Первый и второй - запросы, ответы на которые слушает нода. Происходят раз в определенный период времени.

Третий и четвертый - запросы, порожденные нодой, если процесс остановился. Различие в том, что если ответ FAIL то нода продолжает пытаться запустить его. Если ответ UNABLE_TO_LAUNCH то значит, что лимит запусков исчерпан и эта нода больше не будет пытаться его запустить.

Пятый - тоже запрос, порожденный нодой, если процесс успешно завершен. Больше запускаться он не будет и будет помечен успешным в базе данных.

Формат ответа сервера на запросы 1 и 2 - поле action, которое принимает значения "exec" и "wait". Если action принимает значение "exec", то в ответе есть еще одно поле task, которое описывает процессы, которые нужно запустить, а так же uuid4 идентификатор каждого процесса.
###
---
### Хранение информации ###

По конфигурационному файлу создается (если до этого не была создана) база данных. Возможно всесто использования конфигурационного файла, использовать уже готовую базу данных.
В базе данных есть 3 таблицы. nodes хранит время последнего посещения для каждой из нод. processes хранит состояния каждого из процессов tasks хранит описание заданий, ставящихся перед нодами. Если в таблице tasks добавить новое, либо удалить старое задание (для работы с базой во время работы кластера предусмотрен веб интерфейс), то изменения будут правильно обрабатываться кластером.

Так как прогамма мастера многопоточная (об этом позже), то для избежания ситуаций с Data Race все функции работы с базой обернуты в декоратор

```
#!python3

lock = Lock()
def MakeOneThreaded(Fn):
    def Locker(*args, **kwargs):
        try:
            lock.acquire(True)
            return Fn(*args, **kwargs)
        finally:
            lock.release()
    return Locker
```

### Структура мастера ###
Мастер выполняет tornado web server, а так же 2 потока.

1) StatusChecker. Он проверяет время последнего подключения каждой из нод и информирует об их отключении (Так как нода должна отчитываться раз фиксированное время, то отключением считается потеря нескольких подряд идущих отчетов)
2) NodeRemaper. Он занимается перераспределением программ с отключившихся нод, а так же программ, которых не могут работать на присвоенных им пользователем нодах.
Для каждого такого процесса NodeRemaper выбирает активную ноду, на которой меньше всего в данный момент запущено процессов, а так же данный процесс еще не падал на этой ноде.

### Пользовательский интерфейс ###

После инициализации мастера пользователю становится доступен web интерфейс по адресу http://ip:port/run/. Веб интерфейс позволяет оперировать со списком заданий при помощи Sql команд, а так же просматривать таблицы базы данных. 

## Возможные пути развитие проекта ##

1) Улучшеный алгоритм Node_Remaper'а. Так как не все задачи равны по сложности, не плохо бы учитывать ресурсоемкость заданий при распределении.

2) Улучшеный и безопасный веб интерфейс. В данный момент любой может зайти на веб адрес и выполнить любую команду. Не плохо было бы сделать авторизацию, а так же фильтрацию опасных команд.

3) Ограничение уровня свободы у программ, выполняющихся на нодах. 

4) Передача файлов программ нодам через web.



